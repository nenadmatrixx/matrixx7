<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Matrixx 7</title>
<meta name="theme-color" content="#0f1722" />
<style>
  :root{
    --bg1:#0d1522; --bg2:#0b1a2b; --bg3:#0f1f33; /* anim pozadina */
    --panel:#0f1b2c; --line:#24364e; --muted:#9fb0c9; --text:#eef5ff;
    --green:#2fa36a; --green-bg:#0e3725; --red:#d75555; --red-bg:#401b1b;
    --tile:#101827; --tile-hi:#152339; --accent:#163d6b; --accent2:#1d518e; --warn:#ffd29e;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; color:var(--text);
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial,sans-serif;}
  body{
    background: radial-gradient(1200px 800px at -10% -20%, var(--bg2) 0%, transparent 40%),
                radial-gradient(1000px 600px at 120% 0%, var(--bg3) 0%, transparent 35%),
                linear-gradient(180deg, var(--bg1), #0a1320);
    animation:bgflow 22s ease-in-out infinite alternate;
  }
  @keyframes bgflow{
    0%{background-position:0 0, 100% 0, 0 0}
    100%{background-position:-8% -2%, 105% -4%, 0 0}
  }

  .app{min-height:100dvh; display:grid; grid-template-rows:auto 1fr}
  header{padding:14px 16px; border-bottom:1px solid var(--line);
    background:linear-gradient(90deg,#0f1b2c,#0c1a2b)}
  h1{margin:0; font-size:22px; font-weight:800; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:14px}
  .bar{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center}
  .btn{background:#0c141c; border:1px solid #2a3b4e; border-radius:12px; color:#fff;
    padding:11px 14px; font-size:16px; cursor:pointer;
    transition:transform .18s ease, box-shadow .18s ease, background .18s ease}
  .btn:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.28)}
  .btn:active{transform:translateY(0)}
  /* Pulse animacija za UVOD dugme */
  #btnIntro{position:relative; overflow:visible}
  #btnIntro::after{content:""; position:absolute; inset:-7px; border-radius:14px;
    border:2px solid rgba(99,179,237,.22); opacity:0; pointer-events:none;
    animation:introPulse 3s ease-in-out infinite;}
  @keyframes introPulse{0%{opacity:0; transform:scale(.95)}18%{opacity:1; transform:scale(1)}68%{opacity:0; transform:scale(1.1)}100%{opacity:0}}

  .main{padding:12px; display:grid; gap:12px}
  .panel{background:rgba(16,24,39,.72); backdrop-filter: blur(6px);
    border:1px solid var(--line); border-radius:14px; padding:12px}
  h2{margin:0 0 8px 0; color:#d6e7fb; letter-spacing:.3px; font-size:14px; text-transform:uppercase}
  .muted{color:var(--muted)}
  .right{margin-left:auto}
  .progressBar{width:200px; height:8px; border-radius:999px; background:#0b1624;
    border:1px solid #24364e; overflow:hidden}
  .progressFill{height:100%; width:0%; background:linear-gradient(90deg,#3fa3ff,#6be7c1)}

  .grid{display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));}
  .tile{position:relative; padding:18px; border:1px solid #2a3b4e; border-radius:16px;
    background:linear-gradient(180deg, var(--tile), var(--tile-hi));
    box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden;
    transition:border-color .25s ease, background .25s ease, box-shadow .25s ease, transform .18s ease}
  .tile:hover{transform:translateY(-2px)}
  .tile.unlocked{border-color:#2c6a45; box-shadow:0 14px 36px rgba(47,163,106,.25)}
  .tile.locked{border-color:#6a2c2c; background:linear-gradient(180deg, var(--tile), #181520);
    box-shadow:0 12px 34px rgba(215,85,85,.18)}
  .status{display:inline-block; padding:5px 12px; border-radius:999px; font-size:13px; border:1px solid #2a3b4e}
  .status.ok{background:var(--green-bg); color:#baf4ce; border-color:#2c6a45}
  .status.lock{background:var(--red-bg); color:#ffc9c9; border-color:#6a2c2c}
  .tday{font-size:20px; font-weight:800; margin:8px 0 6px 0}
  .ttitle{font-size:16px; font-weight:700}
  .tlock{font-size:13px; color:#ffcfbf; margin-top:6px}
  .countdown{font-weight:700; color:var(--warn)}
  .tprogress{font-size:13px; color:#cfe0f4; margin-top:8px}
  .cta{margin-top:12px} .cta .btn{width:100%}

  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}75%{transform:translateX(3px)}}
  .shake{animation:shake .28s}
  .toast{position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
    background:#0f1722; border:1px solid #2a3b4e; padding:10px 12px; border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; z-index:120}

  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:100}
  .lesson-modal{position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.96);
    width:min(560px, 94vw); max-height:90vh;
    background:linear-gradient(180deg,var(--accent),var(--accent2));
    border:1px solid #2a3b4e; border-radius:16px; padding:14px; z-index:110; display:none;
    box-shadow:0 18px 60px rgba(0,0,0,.45); display:none; flex-direction:column; min-height:0;
    opacity:0; transition:opacity .25s ease, transform .25s ease}
  .lesson-modal.show{display:flex; opacity:1; transform:translate(-50%,-50%) scale(1)}
  .lesson-modal h3{margin:0 0 10px 0; font-size:18px; display:flex; align-items:center; justify-content:space-between}
  .xbtn{background:transparent; border:0; cursor:pointer; width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px}
  .xbtn:hover{background:rgba(0,0,0,.2)}
  .lesson-content{white-space:pre-wrap; font-size:17px; line-height:1.65;
    background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:12px; flex:1 1 auto; min-height:0; overflow:auto;
    animation:fadein .35s ease both}
  @keyframes fadein{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)}}
  .notes{margin-top:10px}
  .notes textarea{width:100%; min-height:90px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.18); color:#fff; padding:10px; font-size:16px; resize:vertical}
  .lesson-actions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .check{display:flex; align-items:center; gap:8px; font-size:16px}

  @media (max-width:540px){
    .lesson-modal{width:96vw; max-height:92vh}
    .lesson-content{font-size:16.5px}
    .tday{font-size:18px}
    .ttitle{font-size:15px}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div style="display:flex; align-items:center; gap:12px;">
      <div>
        <h1>Matrixx 7</h1>
        <div class="sub" id="subLine">Dan 1 je odmah otključan • Ostali dani se otključavaju prema satima iz sadržaja.</div>
      </div>
      <div class="right" aria-label="Napredak">
        <div class="progressBar" aria-hidden="true"><div class="progressFill" id="progFill"></div></div>
      </div>
    </div>
    <div class="bar">
      <button class="btn" id="btnIntro" aria-label="Uvod">Uvod</button>
    </div>
  </header>

  <section class="main" aria-live="polite">
    <div class="panel">
      <h2>Plan i napredak</h2>
      <div class="muted" id="progressTxt">Napredak: 0%</div>
    </div>

    <div class="panel">
      <h2>Putanja</h2>
      <div class="grid" id="tiles"></div>
    </div>
  </section>
</div>

<div class="toast" id="toast" role="status"></div>

<!-- Intro modal -->
<div class="overlay" id="introOv"></div>
<div class="lesson-modal" id="introMd" role="dialog" aria-modal="true" aria-labelledby="introTitle">
  <h3 id="introTitle">
    UVOD
    <button class="xbtn" id="introClose" aria-label="Zatvori uvod">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </h3>
  <div class="lesson-content" id="introBody"></div>
  <div class="lesson-actions">
    <button class="btn" id="introStart">Započni</button>
  </div>
</div>

<!-- Lesson modal -->
<div class="overlay" id="lessonOv"></div>
<div class="lesson-modal" id="lessonMd" role="dialog" aria-modal="true" aria-labelledby="lessonTitle">
  <h3 id="lessonTitle">
    Vežba
    <button class="xbtn" id="btnCloseLesson" aria-label="Zatvori vežbu">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </h3>
  <div class="lesson-content" id="lessonBody">...</div>
  <div class="notes">
    <label for="notesArea">Šta sam primetio danas?</label>
    <textarea id="notesArea" placeholder="Brza beleška (auto-čuvanje)"></textarea>
  </div>
  <div class="lesson-actions">
    <label class="check"><input type="checkbox" id="chkDone" aria-label="Pročitano"> Pročitano</label>
  </div>
</div>

<script>
/* ===================== KONFIGURACIJA ===================== */
const API = 'https://script.google.com/macros/s/AKfycbyqzUcaI2gS7hfvOO43pPYSUR_P9tYEn94UHA_JeT3EjgEzeKfd-P1M1sGgmQYWy270/exec'; // tvoj provereni URL
const PAY_LINK = ''; // opcionalno: PayPal/Stripe/Gumroad link
const LS='mx7_sheet_unlock_state_v1'; // localStorage ključ

/* ===== Helpers & audio ===== */
const $ = (q)=>document.querySelector(q);
function toast(msg, ms=1400){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
function timeLeft(ms){ if(ms<=0) return '00:00:00'; const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return h+':'+m+':'+ss; }
let audioCtx=null;
function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } }
function clickBeep(freq=520, ms=100, vol=0.035){
  try{
    ensureAudio(); if(audioCtx.state==='suspended') audioCtx.resume();
    const ctx=audioCtx; const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
    g.gain.value=vol; o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + ms/1000); o.stop(ctx.currentTime + ms/1000);
  }catch(e){}
}

/* ===== State & unlock logika ===== */
const now = ()=>Date.now();
const S = ()=>{ try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return {}} };
const W = (s)=>localStorage.setItem(LS, JSON.stringify(s));
function setPremium(v){ const s=S(); s.premium = !!v; W(s); }
function hasPremium(){ const s=S(); return !!s.premium; }

function ensureStarted(hoursForDay1){
  const s=S();
  if(!s.startedAt){
    s.startedAt = now();
    s.done = {};
    s.h = hoursForDay1 || 12; // default 12h
    W(s);
  }
}
function progressPct(totalDays){ const s=S(); let c=0; for(const k in (s.done||{})){ if(s.done[k]) c++; } return Math.round(100*c/Math.max(1,totalDays)); }
function markDone(day,val){ const s=S(); if(!s.done) s.done={}; s.done[day]=!!val; W(s); renderHeader(currentItems); }

function isUnlocked(day, items){
  if(day===1) return true; // Dan 1 odmah
  const s=S(); if(!s.startedAt) return false;
  const unlockTime = unlockAt(day, items);
  return now() >= unlockTime;
}
function unlockAt(day, items){
  const s=S(); if(!s.startedAt) return null;
  let accH=0;
  for(let d=2; d<=day; d++){
    const prev = items.find(x=>x.day===d-1);
    accH += (prev ? (prev.lockedAfterHours||12) : 12);
  }
  return s.startedAt + accH*60*60*1000;
}
function firstNotUnlocked(items){
  const ds = items.filter(x=>x.day>=1).map(x=>x.day).sort((a,b)=>a-b);
  for(const d of ds){ if(!isUnlocked(d, items)) return d; }
  return null;
}

/* ===== Učitavanje sadržaja iz Sheeta ===== */
async function loadContent(){
  try{
    const res = await fetch(API + '?route=content', {method:'GET', cache:'no-store'});
    const js = await res.json();
    if(js.ok && Array.isArray(js.items) && js.items.length){
      localStorage.setItem('mx7_content_cache', JSON.stringify(js.items));
      return js.items;
    }
  }catch(e){}
  // Ako API ne vrati ništa: proba iz cache-a (ako postoji)
  const cache = localStorage.getItem('mx7_content_cache');
  if(cache){
    try{ return JSON.parse(cache); }catch{}
  }
  return []; // čisto prazan skup (bez minimalnih dummy dana)
}

/* ===== Premium verifikacija preko ?token= ===== */
function qs(name){ return new URLSearchParams(location.search).get(name); }
async function verifyPremiumIfAny(){
  const token = qs('token');
  if(!token) return;
  try{
    const res = await fetch(API + '?route=verify&token='+encodeURIComponent(token));
    const js = await res.json();
    if(js.ok && js.premium){
      setPremium(true);
      history.replaceState({}, '', location.origin + location.pathname); // očisti query
      toast('Premium otključan');
    }
  }catch(e){}
}

/* ===== Render ===== */
let currentItems = [];
let introItem = null;

function renderHeader(items){
  const totalDays = items.filter(x=>x.day>=1).length || 7;
  $('#progressTxt').textContent = 'Napredak: '+progressPct(totalDays)+'%';
  $('#progFill').style.width = progressPct(totalDays)+'%';
}

function renderTiles(items){
  const grid = $('#tiles'); grid.innerHTML='';

  if(!items.length){
    const empty = document.createElement('div');
    empty.className='panel';
    empty.innerHTML='<div class="muted">Nema sadržaja. Proveri Sheet tab <b>Matrixx_Content</b> i redeploy GAS Web App.</div>';
    grid.parentElement.appendChild(empty);
    return;
  }

  // UVOD (day=0)
  introItem = items.find(x=>x.day===0) || {title:'Uvod', body:'', lockedAfterHours:0, paidTier:'free'};
  const introTile = document.createElement('div');
  introTile.className='tile unlocked';
  introTile.innerHTML = `
    <div class="status ok">UVOD</div>
    <div class="tday">Uvod</div>
    <div class="ttitle">${introItem.title || 'O čemu je Matrixx'}</div>
    <div class="tprogress">Status: spremno</div>
    <div class="cta"><button class="btn">Otvori</button></div>`;
  introTile.querySelector('.btn').addEventListener('click',()=>{ clickBeep(); openIntro(); });
  grid.appendChild(introTile);

  const onlyDays = items.filter(x=>x.day>=1).sort((a,b)=>a.day-b.day);
  const nextL = firstNotUnlocked(items);

  for(const it of onlyDays){
    const d = it.day;
    const isPrem = (it.paidTier||'free')==='premium';
    const unlockedByTime = isUnlocked(d, items);
    const unlocked = unlockedByTime && (!isPrem || hasPremium());
    const tile = document.createElement('div');
    tile.className = 'tile ' + (unlocked ? 'unlocked' : 'locked');
    const statusClass = unlocked ? 'ok' : 'lock';

    tile.innerHTML = `
      <div class="status ${statusClass}">${unlocked?'OTKLJUČANO': (isPrem && !hasPremium() ? 'PREMIUM' : 'ZAKLJUČANO')}</div>
      <div class="tday">Dan ${d}</div>
      <div class="ttitle">${it.title || 'Vežba'}</div>
      <div class="tlock"><span class="countdown"></span></div>
      <div class="tprogress">${unlocked? (isDayDone(d)?'Status: završeno':'Status: spremno') : (isPrem && !hasPremium() ? 'Status: premium zaključano' : 'Status: zaključano')}</div>
      <div class="cta">
        ${isPrem && !hasPremium()
          ? `<a class="btn" href="${PAY_LINK||'#'}" target="_blank" rel="noopener">Otvori Premium</a>`
          : `<button class="btn" ${unlocked?'':'disabled'}>${unlocked?'Otvori vežbu':'Zaključano'}</button>`}
      </div>
    `;

    const btn = tile.querySelector('.btn');
    const cd = tile.querySelector('.countdown');
    const ua = unlockAt(d, items);
    const showCd = (!unlockedByTime) && (nextL===d) && ua && (ua - now() <= (it.lockedAfterHours||12)*60*60*1000);
    if(showCd){ cd.textContent = 'Otključava se za ' + timeLeft(Math.max(0, ua - now())); }

    if(!(isPrem && !hasPremium()) && btn){
      btn.addEventListener('click', ()=>{
        if(unlocked){
          clickBeep();
          if(d===1) ensureStarted(it.lockedAfterHours||12);
          openLesson(d, it);
        }else{
          tile.classList.add('shake'); setTimeout(()=>tile.classList.remove('shake'), 320);
          toast(isPrem && !hasPremium() ? 'Premium zaključano' : 'Još je zaključano');
        }
      });
    }

    grid.appendChild(tile);
  }
}

/* Modal kontrole */
function showIntro(show){ $('#introOv').style.display = show?'block':'none'; const md=$('#introMd'); md.classList.toggle('show', show); }
function showLesson(show){ $('#lessonOv').style.display = show?'block':'none'; const md=$('#lessonMd'); md.classList.toggle('show', show); }

function openIntro(){
  $('#introBody').textContent = introItem?.body || '';
  showIntro(true);
}
$('#introClose').addEventListener('click',()=> showIntro(false));
$('#btnIntro').addEventListener('click',()=> openIntro());
$('#introStart').addEventListener('click',()=>{ if(currentItems?.length){ ensureStarted(currentItems.find(x=>x.day===1)?.lockedAfterHours||12); showIntro(false); renderTiles(currentItems); renderHeader(currentItems);} });

let currentDay=null;
function openLesson(day, it){
  currentDay = day;
  $('#lessonTitle').childNodes[0].nodeValue = (it?.title ? it.title : ('Vežba — Dan '+day)) + ' ';
  $('#lessonBody').textContent = it?.body || 'Nema teksta.';
  $('#notesArea').value = localStorage.getItem(LS+'_notes_'+day) || '';
  $('#chkDone').checked = isDayDone(day);
  showLesson(true);
}
$('#btnCloseLesson').addEventListener('click',()=> showLesson(false));
function isDayDone(day){ const s=S(); return !!(s.done && s.done[day]); }
$('#chkDone').addEventListener('change',(e)=> markDone(currentDay, e.target.checked));
$('#notesArea').addEventListener('input',(e)=> localStorage.setItem(LS+'_notes_'+currentDay, e.target.value||''));

/* ===== INIT ===== */
(async function init(){
  await verifyPremiumIfAny();
  currentItems = await loadContent();    // koristi Sheet ili cache
  renderTiles(currentItems);
  renderHeader(currentItems);

  // Tajmer za countdown i auto-unlock (svake 1s)
  setInterval(()=>{
    renderHeader(currentItems);
    const tiles = Array.from($('#tiles').children).slice(1); // preskoči Uvod
    const nextL = firstNotUnlocked(currentItems);
    const sorted = currentItems.filter(x=>x.day>=1).sort((a,b)=>a.day-b.day);
    for(let i=0;i<tiles.length;i++){
      const it = sorted[i]; if(!it) continue;
      const d = it.day;
      const node = tiles[i];
      const status=node.querySelector('.status'); const btn=node.querySelector('.btn'); const cd=node.querySelector('.countdown');
      const unlockedByTime = isUnlocked(d, currentItems);
      const premLock = (it.paidTier||'free')==='premium' && !hasPremium();
      const unlocked = unlockedByTime && !premLock;
      if(unlocked && status.classList.contains('lock')){
        node.classList.remove('locked'); node.classList.add('unlocked');
        status.className='status ok'; status.textContent='OTKLJUČANO';
        if(btn && btn.tagName==='BUTTON'){ btn.disabled=false; btn.textContent='Otvori vežbu'; }
        cd.textContent='';
      }
      if(!unlockedByTime){
        const ua=unlockAt(d, currentItems); const show=(nextL===d) && ua && (ua - now() <= (it.lockedAfterHours||12)*60*60*1000);
        cd.textContent = show ? ('Otključava se za '+ timeLeft(Math.max(0, ua - now()))) : '';
      } else {
        cd.textContent = premLock ? 'Premium zaključano' : '';
      }
    }
  }, 1000);
})();
</script>
</body>
</html>

<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Matrixx 30 dana izazov</title>
<meta name="theme-color" content="#0f1722">
<style>
  :root{--bg:#0b1220;--panel:#0f1b2c;--line:#24364e;--text:#eaf2ff;--muted:#9fb0c9;--green:#2fa36a;--green-bg:#0e3725;--red:#d75555;--red-bg:#3a1515;--gold:#f6c453}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b1220,#0f1729);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
  header{padding:16px;background:#0e1a2b;border-bottom:1px solid var(--line)}
  h1{margin:0;font-size:22px;font-weight:800}
  main{padding:14px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .tile{padding:16px;border:1px solid #2a3b4e;border-radius:14px;background:#0d1626;transition:transform .15s}
  .tile:hover{transform:translateY(-2px)}
  .status{display:inline-block;padding:5px 10px;border-radius:999px;border:1px solid #2a3b4e;font-size:13px}
  .okb{background:var(--green-bg);color:#baf4ce;border-color:#2c6a45}
  .lockb{background:var(--red-bg);color:#ffc7c7;border-color:#6a2c2c}
  .premium{display:inline-flex;align-items:center;gap:6px;border-color:#7a5b1b;background:rgba(246,196,83,.12);color:#ffd88a}
  .tday{font-size:18px;font-weight:800;margin:4px 0}
  .info{font-size:13px;color:#cfe0f4;margin-top:6px}
  .btn{display:inline-block;background:#0c141c;border:1px solid #2a3b4e;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.gold{border-color:#7a5b1b;background:rgba(246,196,83,.1)}
  /* Modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:90}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);
    width:min(560px,94vw);max-height:90vh;background:#133156;border:1px solid #29466d;border-radius:14px;padding:12px;display:none;z-index:100;opacity:0;transition:opacity .2s,transform .2s}
  .modal.show{display:flex;flex-direction:column;opacity:1;transform:translate(-50%,-50%) scale(1)}
  .modal h3{margin:0 0 8px;display:flex;align-items:center;justify-content:space-between}
  .xbtn{border:0;background:transparent;cursor:pointer;width:36px;height:36px;border-radius:8px}
  .xbtn:hover{background:rgba(0,0,0,.2)}
  .content{flex:1 1 auto;min-height:0;overflow:auto;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;white-space:pre-wrap;font-size:17px;line-height:1.6}
  .notes{margin-top:10px}
  .notes textarea{width:100%;min-height:90px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:#fff;padding:10px;font-size:16px}
  .actions{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  /* mini modal za token / info */
  .mini{width:min(420px,92vw)}
  .field{display:flex;gap:8px}
  .field input{flex:1 1 auto;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.2);color:#fff;padding:10px 12px;font-size:16px}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0c2a1a;border:1px solid #2e5b3e;color:#c4ffd8;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .2s}
  .toast.show{opacity:1}
  /* konfete */
  .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:200}
  .confetti .p{position:absolute;width:8px;height:12px;opacity:.95;border-radius:2px;will-change:transform,opacity}
  @keyframes fall {
    0% { transform:translateY(-10vh) rotate(0deg) }
    100% { transform:translateY(110vh) rotate(720deg) }
  }
  @media (max-width:540px){ .content{font-size:16.4px} .tday{font-size:16px} }
</style>
</head>
<body>
<header>
  <h1>Matrixx 30 dana izazov</h1>
</header>

<main>
  <div id="grid" class="grid"></div>
</main>

<!-- konfete sloj -->
<div id="fx" class="confetti" aria-hidden="true"></div>

<!-- modal vežbe -->
<div id="ov" class="overlay"></div>
<div id="md" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttl">
  <h3><span id="ttl">Vežba</span>
    <button class="xbtn" id="close" aria-label="Zatvori">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </h3>
  <div id="body" class="content">...</div>
  <div class="notes">
    <label for="nt">Šta sam primetio danas?</label>
    <textarea id="nt" placeholder="Brza beleška (auto-čuvanje)"></textarea>
  </div>
  <div class="actions">
    <label><input type="checkbox" id="done"> Pročitano</label>
  </div>
</div>

<!-- mini modal: token -->
<div id="ov2" class="overlay"></div>
<div id="md2" class="modal mini" role="dialog" aria-modal="true" aria-labelledby="ttl2">
  <h3><span id="ttl2">Unesi premium token</span>
    <button class="xbtn" id="close2" aria-label="Zatvori">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </h3>
  <div class="field">
    <input id="tokenInput" placeholder="npr. MX7-ABCD-1234">
    <button class="btn gold" id="tokenBtn">Potvrdi</button>
  </div>
  <div id="tokMsg" class="info" style="margin-top:8px"></div>
</div>

<!-- mini modal: info za Dan 8 -->
<div id="ov3" class="overlay"></div>
<div id="md3" class="modal mini" role="dialog" aria-modal="true" aria-labelledby="ttl3">
  <h3><span id="ttl3">Premium od Dana 8</span>
    <button class="xbtn" id="close3" aria-label="Zatvori">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </h3>
  <div class="content" style="min-height:120px">
    Od Dana 8 do 30 nalaze se napredne vežbe i vodiči.<br><br>
    Otključavanjem Premium paketa dobijaš kontinuirani napredak, dodatne mikro-rutine i strukturu do 30. dana.
  </div>
</div>

<div id="t" class="toast">Premium aktiviran ✅</div>

<script>
/*** PayPal (može i &pay= u URL-u) ***/
const PAYMENT_URL = new URLSearchParams(location.search).get('pay')
  || 'https://www.paypal.com/paypalme/nenadvip/20usd';

/*** GAS URL ***/
const API = 'https://script.google.com/macros/s/AKfycbw2AtMAeXudx-dIfF8nrGYn62KVa3rPhSB3HuFMGthF7hq97o3nabWG85fsGixWSHS2/exec';

/*** FALLBACK ***/
const FALLBACK = [
  {day:0,title:'Uvod',body:'7-DNEVNI MATRIXX IZAZOV — Reprogramiranje identiteta za 10 minuta dnevno.\nMatrixx podiže nivo svesti; viši nivo = bolje odluke, emocije, odnosi.\nMetafora nebodera: što si više, šira slika. Cilj: iz mehaničnog u svesno, sprat po sprat.',lockedAfterHours:0,paidTier:'free'},
  {day:1,title:'',body:'Nikada ne prekrštajte noge dok sedite (kod kuće, na poslu, u javnosti).\nZašto: prekrštanje je nesvesni obrazac koji vraća stari identitet. Promena počinje razbijanjem posturalnih petlji. 7 dana: sedite drugačije.',lockedAfterHours:12,paidTier:'free'},
  {day:2,title:'',body:'Desna noga ulazi kroz svaka vrata; leva noga ulazi kroz vrata toaleta.\nPonavljajte—kad zaboravite, nastavite. Svaki zaborav je ogledalo mehaničnosti; svaki svesno izveden korak gradi prisustvo.',lockedAfterHours:12,paidTier:'free'},
  {day:3,title:'',body:'Svaki put kada dodirnete kvaku, tiho recite: „Ja Jesam.”\nOsetite ruku, dodir i prisustvo tela. Reči ne menjaju — svest menja.',lockedAfterHours:12,paidTier:'free'},
  {day:4,title:'',body:'Dok razgovarate sa nekim, deo pažnje stavite na desno stopalo (pritisak, senzacije).\nPodeljena pažnja gradi unutrašnje prisustvo i autoritet.',lockedAfterHours:12,paidTier:'free'},
  {day:5,title:'',body:'Od 8:00 do 20:00, na početku svakog sata, zastanite i recite: „Ja Jesam.”\nSvaki sat postaje kontrolna tačka svesti.',lockedAfterHours:12,paidTier:'free'},
  {day:6,title:'',body:'Polako brojite 1→50, pa 50→1. Ponovite 5×. Um će lutati — istrajte.\nBuka opada, ostaje brojanje i prisustvo.',lockedAfterHours:12,paidTier:'free'},
  {day:7,title:'',body:'Pojedite ceo obrok u tišini: bez telefona i razgovora.\nPosmatrajte pokrete, ukus, senzacije i reakcije uma.',lockedAfterHours:12,paidTier:'free'},
];

/*** STATE ***/
const LS='mx7_state_v10';
const qs=new URLSearchParams(location.search);
if(qs.get('reset')==='1'){ try{ localStorage.removeItem(LS); localStorage.removeItem('mx7_content_cache'); }catch{} }
if(qs.get('pro')==='1'){ const s=S(); s.premium=true; W(s); }
const $=q=>document.querySelector(q);
function S(){ try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return{}} }
function W(v){ localStorage.setItem(LS, JSON.stringify(v)); }
function ensureStarted(h){ const s=S(); if(!s.startedAt){ s.startedAt=Date.now(); s.h=h||12; s.done={}; W(s);} }
function isDone(d){ const s=S(); return !!(s.done&&s.done[d]); }
function markDone(d,v){ const s=S(); if(!s.done)s.done={}; s.done[d]=!!v; W(s); }
function hasPremium(){ const s=S(); return !!s.premium; }
function unlockAt(day, items){
  const s=S(); if(!s.startedAt) return null; let acc=0;
  for(let d=2; d<=day; d++){ const prev=items.find(x=>x.day===d-1); const h=(prev && Number(prev.lockedAfterHours))||12; acc+=h; }
  return s.startedAt + acc*3600*1000;
}
function isUnlockedByTime(day, items){ if(day===1) return true; const t=unlockAt(day,items); return t && Date.now()>=t; }
function timeLeft(ms){ if(ms<=0)return'00:00:00'; const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}`; }

/*** LOAD ***/
async function loadItems(){
  try{
    const r=await fetch(API+'?route=content',{cache:'no-store'});
    const tx=await r.text(); const j=JSON.parse(tx);
    if(j.ok && Array.isArray(j.items) && j.items.length){
      const norm=j.items.map(it=>({
        day: Number(it.day)||0,
        title: it.title? String(it.title).replace(/^Dan\s*\d+\s*[—-]\s*/,'') : '',
        body: String(it.body||''),
        lockedAfterHours: Number(it.lockedAfterHours)||12,
        paidTier: String(it.paidTier||'free').toLowerCase()
      })).sort((a,b)=>a.day-b.day);
      localStorage.setItem('mx7_content_cache', JSON.stringify(norm));
      return norm;
    }
    throw new Error('empty');
  }catch(e){
    const cache=localStorage.getItem('mx7_content_cache');
    if(cache){ return JSON.parse(cache); }
    return FALLBACK;
  }
}

/*** AUDIO — bez oscilatora, one-shot buffer, samo na klik (nema autoplay) ***/
const AUDIO_ENABLED = !(/(?:snd=0|nosnd=1)/.test(location.search));
const audio = { ctx:null, armed:false, bufClick:null, bufUnlock:null, live:new Set() };
function initAudio(){
  if(!AUDIO_ENABLED || audio.armed) return;
  try{
    audio.ctx = new (window.AudioContext||window.webkitAudioContext)();
    audio.ctx.resume?.();
    const mkBuf=(ms, amp, curve=6)=>{
      const sr = audio.ctx.sampleRate;
      const len = Math.max(1, Math.floor(sr*(ms/1000)));
      const buf = audio.ctx.createBuffer(1, len, sr);
      const data = buf.getChannelData(0);
      for(let i=0;i<len;i++){
        const n = (Math.random()*2-1)*amp;
        const env = Math.exp(-curve*i/len);
        data[i] = n*env;
      }
      return buf;
    };
    audio.bufClick  = mkBuf(40, 0.18, 6);   // kratak, tih
    audio.bufUnlock = mkBuf(140,0.16, 5);   // malo duži i bogatiji
    audio.armed = true;
  }catch(e){ audio.armed=false; }
}
document.addEventListener('pointerdown', initAudio, {once:true});
function playBuf(buf){
  if(!AUDIO_ENABLED || !audio.armed || !audio.ctx || !buf) return;
  try{
    const src=audio.ctx.createBufferSource(), g=audio.ctx.createGain();
    g.gain.value=0.7;
    src.buffer=buf; src.connect(g); g.connect(audio.ctx.destination);
    const now=audio.ctx.currentTime;
    src.start(now); src.stop(now + (buf.duration||0.2) + 0.01);
    src.onended=()=>{ try{src.disconnect(); g.disconnect();}catch{} audio.live.delete(src); };
    audio.live.add(src);
    setTimeout(()=>{ if(audio.live.has(src)){ try{src.stop(); src.disconnect(); g.disconnect();}catch{} audio.live.delete(src); } }, Math.ceil((buf.duration||0.2)*1000)+100);
  }catch{}
}
const sClick = ()=>playBuf(audio.bufClick);
const sUnlock= ()=>playBuf(audio.bufUnlock);

/*** KONFETE — lagani CSS/JS, bez biblioteka ***/
function confetti(ms=1200, count=60){
  const root = document.getElementById('fx');
  if(!root) return;
  const colors = ['#6ee7b7','#93c5fd','#fde68a','#fca5a5','#c4b5fd','#fcd34d'];
  for(let i=0;i<count;i++){
    const p=document.createElement('div');
    p.className='p';
    p.style.left = Math.round(Math.random()*100)+'vw';
    p.style.background = colors[i%colors.length];
    p.style.animation = `fall ${0.8 + Math.random()*1.2}s linear forwards`;
    p.style.transform = `translateY(-10vh) rotate(${Math.random()*360}deg)`;
    p.style.opacity = 0.9 + Math.random()*0.1;
    root.appendChild(p);
    setTimeout(()=>{ if(p.parentNode) p.parentNode.removeChild(p); }, ms);
  }
}

/*** RENDER (tajmeri bez rekurzije) ***/
const activeIntervals = new Set();
let rafRefreshQueued = false;
function queueRefresh(items){ if(rafRefreshQueued) return; rafRefreshQueued=true; requestAnimationFrame(()=>{ rafRefreshQueued=false; render(items); }); }
function clearIntervals(){ activeIntervals.forEach(id=>clearInterval(id)); activeIntervals.clear(); }

function normalizeRange(listRaw){
  const max = Math.max(7, ...listRaw.map(x=>x.day||0));
  const by=new Map(listRaw.map(x=>[Number(x.day)||0,x]));
  const out=[];
  for(let d=0; d<=max; d++){
    if(by.has(d)) out.push(by.get(d));
    else if(d===0) out.push({day:0,title:'Uvod',body:'',lockedAfterHours:0,paidTier:'free'});
    else out.push({day:d,title:``,body:'(nema teksta u Sheet-u)',lockedAfterHours:12,paidTier:d<=7?'free':'premium'});
  }
  return out.sort((a,b)=>a.day-b.day);
}
function nextLockedDay(list){
  for(const it of list){ if(it.day>=2 && it.paidTier!=='premium' && !isUnlockedByTime(it.day,list)) return it.day; }
  return null;
}
function canOpen(it, list){
  if(it.day===0 || it.day===1) return true;
  if(it.paidTier==='premium' && !hasPremium()) return false;
  return isUnlockedByTime(it.day, list);
}

function render(listRaw){
  clearIntervals();
  const list=normalizeRange(listRaw);
  const g=$('#grid'); g.innerHTML='';

  // UVOD
  g.appendChild(tileUvod(list.find(x=>x.day===0)));

  // tajmer samo za PRVI zaključani free dan
  const nextD = nextLockedDay(list);

  list.filter(x=>x.day>=1).forEach(it=>{
    g.appendChild(tileDan(it,list,nextD));
  });
}

function tileUvod(intro){
  const el=document.createElement('div'); el.className='tile';
  el.innerHTML=`
    <div class="tday">Uvod</div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn">Otvori</button>
    </div>`;
  el.querySelector('.btn').onclick=()=>{ sClick(); openLesson(0,intro); };
  return el;
}
function tileDan(it, all, nextLocked){
  const d=Number(it.day)||0;
  const open = canOpen(it, all);
  const isPrem = it.paidTier==='premium';
  const el=document.createElement('div'); el.className='tile';
  const badges=[]; badges.push(`<div class="status ${open?'okb':'lockb'}">${open?'OTKLJUČANO':'ZAKLJUČANO'}</div>`); if(isPrem) badges.push(`<div class="status premium">PREMIUM</div>`);
  // info “Pročitaj” na danu 8
  const infoBtn = (d===8) ? `<button class="btn" data-info8="1">Pročitaj</button>` : '';

  el.innerHTML=`
    <div style="display:flex;gap:8px;flex-wrap:wrap">${badges.join('')}</div>
    <div class="tday">Dan ${d}</div>
    <div class="info">
      ${open ? (isDone(d)?'Završeno':'Spremno')
             : (isPrem && !hasPremium() ? 'Premium sadržaj' 
                : (nextLocked===d ? 'Otključava se za <b class="cd"></b>' : 'Zaključano'))}
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" ${open?'':'disabled'}>Otvori vežbu</button>
      ${infoBtn}
      ${(!open && isPrem && !hasPremium()) ? `<button class="btn gold buy">Otključaj Premium</button><button class="btn" id="tok_${d}">Imam token</button>`:''}
    </div>`;
  if(open){
    el.querySelector('.btn').onclick=()=>{ sClick(); openLesson(d,it); if(d===1){ sUnlock(); confetti(1400,70);} };
  }else{
    const cd=el.querySelector('.cd');
    if(cd && nextLocked===d){
      const tick=()=>{ const left=Math.max(0,(unlockAt(d,all)||0)-Date.now()); cd.textContent=timeLeft(left); if(left<=0){ sUnlock(); confetti(1200,60); queueRefresh(all); } };
      tick();
      const iv=setInterval(()=>{ if(!document.body.contains(cd)) return clearInterval(iv); tick(); },1000);
      activeIntervals.add(iv);
    }
    const buy=el.querySelector('.buy');
    if(buy){ buy.onclick=()=>{ sClick(); window.open(PAYMENT_URL,'_blank'); }; }
    const tokBtn=el.querySelector(`#tok_${d}`);
    if(tokBtn){ tokBtn.onclick=()=>{ sClick(); openTokenModal(); } }
  }
  const info8 = el.querySelector('[data-info8]');
  if(info8){ info8.onclick=()=>{ sClick(); openInfo8(); } }

  return el;
}

/*** MODAL VEŽBE ***/
let currentDay=null;
function openLesson(day, it){
  if(day===1 && !S().startedAt){ ensureStarted(Number(it.lockedAfterHours)||12); queueRefresh(currentItems); }
  currentDay=day;
  document.getElementById('ttl').textContent = day===0 ? 'Uvod' : `Vežba — Dan ${day}`;
  document.getElementById('body').textContent = it.body||'Nema teksta.';
  document.getElementById('nt').value = localStorage.getItem(LS+'_notes_'+currentDay)||'';
  document.getElementById('done').checked = isDone(currentDay);
  show(true);
}
function show(v){ document.getElementById('ov').style.display=v?'block':'none'; const m=document.getElementById('md'); if(v){ m.classList.add('show'); m.style.display='flex'; }else{ m.classList.remove('show'); setTimeout(()=>m.style.display='none',160);} }
document.getElementById('close').onclick=()=>show(false);
document.getElementById('done').onchange=e=>{ markDone(currentDay,e.target.checked); sClick(); } ;
document.getElementById('nt').oninput=e=>localStorage.setItem(LS+'_notes_'+currentDay,e.target.value||'');

/*** TOKEN MODAL ***/
function show2(v){ document.getElementById('ov2').style.display=v?'block':'none'; const m=document.getElementById('md2'); if(v){ m.classList.add('show'); m.style.display='flex'; }else{ m.classList.remove('show'); setTimeout(()=>m.style.display='none',160);} }
function openTokenModal(){ $('#tokenInput').value=''; $('#tokMsg').textContent=''; show2(true); }
$('#close2').onclick=()=>show2(false);
$('#tokenBtn').onclick=async ()=>{
  const t=$('#tokenInput').value.trim();
  if(!t){ $('#tokMsg').textContent='Unesi token.'; return; }
  $('#tokMsg').textContent='Provera…';
  try{
    const r=await fetch(API+'?route=verify&token='+encodeURIComponent(t),{cache:'no-store'});
    const j=await r.json();
    if(j.ok && j.premium){
      const s=S(); s.premium=true; W(s);
      show2(false); toast('Premium aktiviran ✅'); queueRefresh(currentItems);
    }else{
      $('#tokMsg').textContent='Token nije validan.';
    }
  }catch(e){ $('#tokMsg').textContent='Greška mreže.'; }
};
function toast(msg){ const el=$('#t'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }

/*** INFO DAN 8 ***/
function show3(v){ document.getElementById('ov3').style.display=v?'block':'none'; const m=document.getElementById('md3'); if(v){ m.classList.add('show'); m.style.display='flex'; }else{ m.classList.remove('show'); setTimeout(()=>m.style.display='none',160);} }
function openInfo8(){ show3(true); }
document.getElementById('close3').onclick=()=>show3(false);

/*** INIT ***/
let currentItems=FALLBACK;
(async function(){
  try{
    const items=await loadItems();
    currentItems=items;
    render(items);
  }catch(e){
    currentItems=FALLBACK;
    render(FALLBACK);
  }
})();
</script>
</body>
</html>

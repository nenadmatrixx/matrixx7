<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Matrixx 7</title>
<meta name="theme-color" content="#0f1722">
<style>
  :root{
    --bg:#0b1220; --panel:#0f1b2c; --line:#24364e; --text:#eaf2ff; --muted:#9fb0c9;
    --green:#2fa36a; --green-bg:#0e3725; --red:#d75555; --red-bg:#3a1515; --warn:#ffd29e;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b1220,#0f1729);color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial,sans-serif}
  header{padding:14px 16px;background:#0e1a2b;border-bottom:1px solid var(--line)}
  h1{margin:0;font-size:22px;font-weight:800}
  .sub{color:var(--muted);font-size:14px}
  main{padding:12px;display:grid;gap:12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  h2{margin:0 0 8px;font-size:14px;letter-spacing:.2px;text-transform:uppercase;color:#d7e6fb}
  .ok{color:#baf4ce} .err{color:#ffc7c7}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .tile{padding:16px;border:1px solid #2a3b4e;border-radius:14px;background:#0d1626;transition:transform .15s}
  .tile:hover{transform:translateY(-2px)}
  .status{display:inline-block;padding:5px 10px;border-radius:999px;border:1px solid #2a3b4e;font-size:13px}
  .okb{background:var(--green-bg);color:#baf4ce;border-color:#2c6a45}
  .lockb{background:var(--red-bg);color:#ffc7c7;border-color:#6a2c2c}
  .tday{font-size:18px;font-weight:800;margin:8px 0 4px}
  .ttitle{font-size:15px}
  .info{font-size:13px;color:#cfe0f4;margin-top:6px}
  .btn{display:inline-block;background:#0c141c;border:1px solid #2a3b4e;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:90}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);
    width:min(560px,94vw);max-height:90vh;background:#133156;border:1px solid #29466d;border-radius:14px;padding:12px;display:none;z-index:100;opacity:0;transition:opacity .2s,transform .2s}
  .modal.show{display:flex;flex-direction:column;opacity:1;transform:translate(-50%,-50%) scale(1)}
  .modal h3{margin:0 0 8px;display:flex;align-items:center;justify-content:space-between}
  .xbtn{border:0;background:transparent;cursor:pointer;width:36px;height:36px;border-radius:8px}
  .xbtn:hover{background:rgba(0,0,0,.2)}
  .content{flex:1 1 auto;min-height:0;overflow:auto;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;white-space:pre-wrap;font-size:17px;line-height:1.6}
  .notes{margin-top:10px}
  .notes textarea{width:100%;min-height:90px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:#fff;padding:10px;font-size:16px}
  .actions{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dbg{white-space:pre-wrap;font:12px/1.4 monospace;background:#0a0f18;color:#a6ff9a;border:1px dashed #30405a;padding:8px;border-radius:10px}
  @media (max-width:540px){ .content{font-size:16.5px} .tday{font-size:16px} .ttitle{font-size:14.5px} }
</style>
</head>
<body>
<header>
  <h1>Matrixx 7</h1>
  <div class="sub">Dan 1 je odmah otključan · Ostali dani se otključavaju prema satima iz sadržaja.</div>
</header>

<main>
  <div class="card">
    <h2>Status</h2>
    <div id="status" class="muted">Učitavam…</div>
  </div>

  <div class="card">
    <h2>Podaci iz API-ja (brza dijagnostika)</h2>
    <div id="diag" class="dbg">—</div>
  </div>

  <div class="card">
    <h2>Putanja</h2>
    <div id="grid" class="grid"></div>
  </div>
</main>

<div id="ov" class="overlay"></div>
<div id="md" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttl">
  <h3><span id="ttl">Vežba</span>
    <button class="xbtn" id="close" aria-label="Zatvori">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </h3>
  <div id="body" class="content">...</div>
  <div class="notes">
    <label for="nt">Šta sam primetio danas?</label>
    <textarea id="nt" placeholder="Brza beleška (auto-čuvanje)"></textarea>
  </div>
  <div class="actions">
    <label><input type="checkbox" id="done"> Pročitano</label>
  </div>
</div>

<script>
/*** 1) TVOJ GAS URL – PROVERENO RADI ***/
const API = 'https://script.google.com/macros/s/AKfycbw2AtMAeXudx-dIfF8nrGYn62KVa3rPhSB3HuFMGthF7hq97o3nabWG85fsGixWSHS2/exec';

/*** 2) LOCAL STORAGE KLJUČEVI + RESET PREKO ?reset=1 ***/
const LS = 'mx7_state_v2';
const qs = new URLSearchParams(location.search);
if(qs.get('reset')==='1'){
  try{ localStorage.removeItem(LS); localStorage.removeItem('mx7_content_cache'); }catch{}
}

/*** 3) Kratki helperi ***/
const $ = q => document.querySelector(q);
function timeLeft(ms){ if(ms<=0) return '00:00:00'; const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return h+':'+m+':'+ss; }
function S(){ try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return{}} }
function W(v){ localStorage.setItem(LS, JSON.stringify(v)); }
function ensureStarted(h){ const s=S(); if(!s.startedAt){ s.startedAt=Date.now(); s.h=h||12; s.done={}; W(s);} }
function isDone(d){ const s=S(); return !!(s.done && s.done[d]); }
function markDone(d,v){ const s=S(); if(!s.done)s.done={}; s.done[d]=!!v; W(s); }
function unlockAt(day, items){ const s=S(); if(!s.startedAt) return null; let acc=0; for(let d=2; d<=day; d++){ const prev=items.find(x=>x.day===d-1); acc+= (prev? (prev.lockedAfterHours||12):12); } return s.startedAt + acc*3600*1000; }
function isUnlocked(day, items){ if(day===1) return true; const t=unlockAt(day,items); return t && Date.now()>=t; }

/*** 4) Učitavanje (sa jasnom dijagnostikom) ***/
async function loadItems(){
  const diag=$('#diag');
  try{
    const r = await fetch(API+'?route=content',{cache:'no-store'});
    const raw = await r.text();
    diag.textContent = 'RAW:\n'+raw.slice(0,800) + (raw.length>800?'\n…':'');
    let j; try{ j=JSON.parse(raw) }catch(e){ throw new Error('API nije vratio JSON (vidi RAW gore)'); }
    if(!j.ok) throw new Error('API ok=false');
    if(!Array.isArray(j.items)) throw new Error('API items nije niz');
    localStorage.setItem('mx7_content_cache', JSON.stringify(j.items));
    return j.items;
  }catch(e){
    // fallback iz keša, ako postoji
    const cache = localStorage.getItem('mx7_content_cache');
    if(cache){
      const items = JSON.parse(cache);
      $('#status').innerHTML = '<b class="ok">OK</b> – prikaz iz cache-a ('+(items.length||0)+' stavki)';
      return items;
    }
    $('#status').innerHTML = '<b class="err">Greška</b> – '+(e.message||e);
    throw e;
  }
}

/*** 5) Render UI ***/
function firstLocked(list){
  const ds=list.filter(x=>x.day>=1).map(x=>x.day).sort((a,b)=>a-b);
  for(const d of ds){ if(!isUnlocked(d,list)) return d; }
  return null;
}

function renderGrid(list){
  const g=$('#grid'); g.innerHTML='';
  const intro = list.find(x=>x.day===0);
  if(intro){
    const t=document.createElement('div'); t.className='tile';
    t.innerHTML=`<div class="status okb">UVOD</div>
      <div class="tday">Uvod</div><div class="ttitle">${intro.title||''}</div>
      <div class="info">Status: spremno</div>
      <div style="margin-top:8px"><button class="btn" id="openIntro">Otvori</button></div>`;
    g.appendChild(t);
    t.querySelector('#openIntro').onclick=()=>openLesson(0,intro);
  }

  const days=list.filter(x=>x.day>=1).sort((a,b)=>a.day-b.day);
  const next = firstLocked(list);

  days.forEach(it=>{
    const d=it.day; const unlock=isUnlocked(d,list);
    const tile=document.createElement('div'); tile.className='tile';
    tile.innerHTML=`<div class="status ${unlock?'okb':'lockb'}">${unlock?'OTKLJUČANO':'ZAKLJUČANO'}</div>
      <div class="tday">Dan ${d}</div>
      <div class="ttitle">${it.title||'Vežba'}</div>
      <div class="info">${unlock? (isDone(d)?'Status: završeno':'Status: spremno')
        : (next===d?('Otključava se za <b class="cd"></b>'):'Status: zaključano')}</div>
      <div style="margin-top:8px"><button class="btn" ${unlock?'':'disabled'}>Otvori</button></div>`;
    const btn=tile.querySelector('.btn'); const cd=tile.querySelector('.cd');
    if(btn && unlock) btn.onclick=()=>openLesson(d,it);
    if(cd){
      const tick=()=>{ const left=Math.max(0,(unlockAt(d,list)||0)-Date.now()); cd.textContent=timeLeft(left); if(left<=0){ renderGrid(list);} };
      tick(); const iv=setInterval(()=>{ if(!document.body.contains(cd)) return clearInterval(iv); tick(); },1000);
    }
    g.appendChild(tile);
  });

  $('#status').innerHTML = '<b class="ok">OK</b> – učitano dana: '+days.length;
}

/*** 6) Modal ***/
let currentDay=null;
function openLesson(day, it){
  if(day===1){ ensureStarted(it.lockedAfterHours||12); }
  currentDay=day;
  $('#ttl').textContent = day===0 ? 'Uvod' : (it.title||('Dan '+day));
  $('#body').textContent = it.body||'Nema teksta.';
  $('#nt').value = localStorage.getItem(LS+'_notes_'+day)||'';
  $('#done').checked = isDone(day);
  show(true);
}
function show(v){ $('#ov').style.display=v?'block':'none'; const m=$('#md'); if(v){ m.classList.add('show'); m.style.display='flex'; }else{ m.classList.remove('show'); setTimeout(()=>m.style.display='none',160);} }
$('#close').onclick=()=>show(false);
$('#done').onchange=e=>markDone(currentDay,e.target.checked);
$('#nt').oninput=e=>localStorage.setItem(LS+'_notes_'+currentDay,e.target.value||'');

/*** 7) Init ***/
(async function init(){
  try{
    const items = await loadItems();
    if(!items.length){ $('#status').innerHTML='<b class="err">Greška učitavanja</b> – Nema stavki u Sheet-u.'; return; }
    renderGrid(items);
    // obori keš HTML-a dodatnim parametrom ako ga ima:
    if(!qs.get('v')){ const u=new URL(location.href); u.searchParams.set('v',Date.now()); history.replaceState({},'',u); }
  }catch(e){
    // već je prikazano u #status
    console.error(e);
  }
})();
</script>
</body>
</html>

<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Matrixx 30 dana izazov</title>
<meta name="theme-color" content="#0f1722">
<style>
  :root{--bg:#0b1220;--panel:#0f1b2c;--line:#24364e;--text:#eaf2ff;--muted:#9fb0c9;--green:#2fa36a;--green-bg:#0e3725;--red:#d75555;--red-bg:#3a1515;--gold:#f6c453}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b1220,#0f1729);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
  header{padding:16px;background:#0e1a2b;border-bottom:1px solid var(--line)}
  h1{margin:0;font-size:22px;font-weight:800}
  main{padding:14px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .tile{padding:16px;border:1px solid #2a3b4e;border-radius:14px;background:#0d1626;transition:transform .15s}
  .tile:hover{transform:translateY(-2px)}
  .status{display:inline-block;padding:5px 10px;border-radius:999px;border:1px solid #2a3b4e;font-size:13px}
  .okb{background:var(--green-bg);color:#baf4ce;border-color:#2c6a45}
  .lockb{background:var(--red-bg);color:#ffc7c7;border-color:#6a2c2c}
  .premium{display:inline-flex;align-items:center;gap:6px;border-color:#7a5b1b;background:rgba(246,196,83,.12);color:#ffd88a}
  .tday{font-size:18px;font-weight:800;margin:4px 0}
  .ttitle{font-size:15px}
  .info{font-size:13px;color:#cfe0f4;margin-top:6px}
  .btn{display:inline-block;background:#0c141c;border:1px solid #2a3b4e;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.gold{border-color:#7a5b1b;background:rgba(246,196,83,.1)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:90}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);
    width:min(560px,94vw);max-height:90vh;background:#133156;border:1px solid #29466d;border-radius:14px;padding:12px;display:none;z-index:100;opacity:0;transition:opacity .2s,transform .2s}
  .modal.show{display:flex;flex-direction:column;opacity:1;transform:translate(-50%,-50%) scale(1)}
  .modal h3{margin:0 0 8px;display:flex;align-items:center;justify-content:space-between}
  .xbtn{border:0;background:transparent;cursor:pointer;width:36px;height:36px;border-radius:8px}
  .xbtn:hover{background:rgba(0,0,0,.2)}
  .content{flex:1 1 auto;min-height:0;overflow:auto;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;white-space:pre-wrap;font-size:17px;line-height:1.6}
  .notes{margin-top:10px}
  .notes textarea{width:100%;min-height:90px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:#fff;padding:10px;font-size:16px}
  .actions{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .err{position:fixed;left:0;right:0;top:0;z-index:9999;background:#3a1515;color:#ffd4d4;border-bottom:1px solid #6a2c2c;padding:10px 12px;font-size:13px;display:none}
</style>
</head>
<body>
<header>
  <h1>Matrixx 30 dana izazov</h1>
</header>

<div id="err" class="err"></div>

<main>
  <div id="grid" class="grid"></div>
</main>

<div id="ov" class="overlay"></div>
<div id="md" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttl">
  <h3><span id="ttl">Vežba</span>
    <button class="xbtn" id="close" aria-label="Zatvori">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </h3>
  <div id="body" class="content">...</div>
  <div class="notes">
    <label for="nt">Šta sam primetio danas?</label>
    <textarea id="nt" placeholder="Brza beleška (auto-čuvanje)"></textarea>
  </div>
  <div class="actions">
    <label><input type="checkbox" id="done"> Pročitano</label>
  </div>
</div>

<script>
/*** 0) SIGURAN PayPal link — bez menjanja koda
     (možeš ga poslati kroz ?pay= u URL-u) ***/
const PAYMENT_URL = new URLSearchParams(location.search).get('pay') || 'https://paypal.me/tvojusername/20';

/*** 1) TVOJ GAS URL ***/
const API = 'https://script.google.com/macros/s/AKfycbw2AtMAeXudx-dIfF8nrGYn62KVa3rPhSB3HuFMGthF7hq97o3nabWG85fsGixWSHS2/exec';

/*** 2) FALLBACK ***/
const FALLBACK = [
  {day:0,title:'Uvod',body:'7-DNEVNI MATRIXX IZAZOV — Reprogramiranje identiteta za 10 minuta dnevno.\nMatrixx podiže nivo svesti; viši nivo = bolje odluke, emocije, odnosi.\nMetafora nebodera: što si više, šira slika. Cilj: iz mehaničnog u svesno, sprat po sprat.',lockedAfterHours:0,paidTier:'free'},
  {day:1,title:'Dan 1 — Zaključavanje nogu',body:'Nikada ne prekrštajte noge dok sedite (kod kuće, na poslu, u javnosti).\nZašto: prekrštanje je nesvesni obrazac koji vraća stari identitet. Promena počinje razbijanjem posturalnih petlji. 7 dana: sedite drugačije.',lockedAfterHours:12,paidTier:'free'},
  {day:2,title:'Dan 2 — Ritual koraka',body:'Desna noga ulazi kroz svaka vrata; leva noga ulazi kroz vrata toaleta.\nPonavljajte—kad zaboravite, nastavite. Svaki zaborav je ogledalo mehaničnosti; svaki svesno izveden korak gradi prisustvo.',lockedAfterHours:12,paidTier:'free'},
  {day:3,title:'Dan 3 — Ja sam kvaka',body:'Svaki put kada dodirnete kvaku, tiho recite: „Ja Jesam.”\nOsetite ruku, dodir i prisustvo tela. Reči ne menjaju — svest menja.',lockedAfterHours:12,paidTier:'free'},
  {day:4,title:'Dan 4 — Podeljena pažnja',body:'Dok razgovarate sa nekim, deo pažnje stavite na desno stopalo (pritisak, senzacije).\nPodeljena pažnja gradi unutrašnje prisustvo i autoritet.',lockedAfterHours:12,paidTier:'free'},
  {day:5,title:'Dan 5 — Budilnik na sat vremena',body:'Od 8:00 do 20:00, na početku svakog sata, zastanite i recite: „Ja Jesam.”\nSvaki sat postaje kontrolna tačka svesti.',lockedAfterHours:12,paidTier:'free'},
  {day:6,title:'Dan 6 — Prekidač mentalnih petlji',body:'Polako brojite 1→50, pa 50→1. Ponovite 5×. Um će lutati — istrajte.\nBuka opada, ostaje brojanje i prisustvo.',lockedAfterHours:12,paidTier:'free'},
  {day:7,title:'Dan 7 — Svesno jedenje',body:'Pojedite ceo obrok u tišini: bez telefona i razgovora.\nPosmatrajte pokrete, ukus, senzacije i reakcije uma.',lockedAfterHours:12,paidTier:'free'},
];

/*** 3) STATE ***/
const LS='mx7_state_v5';
const qs=new URLSearchParams(location.search);
if(qs.get('reset')==='1'){ try{ localStorage.removeItem(LS); localStorage.removeItem('mx7_content_cache'); }catch{} }
if(qs.get('pro')==='1'){ const s=S(); s.premium=true; W(s); }
const $=q=>document.querySelector(q);
function S(){ try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return{}} }
function W(v){ localStorage.setItem(LS, JSON.stringify(v)); }
function ensureStarted(h){ const s=S(); if(!s.startedAt){ s.startedAt=Date.now(); s.h=h||12; s.done={}; W(s);} }
function isDone(d){ const s=S(); return !!(s.done&&s.done[d]); }
function markDone(d,v){ const s=S(); if(!s.done)s.done={}; s.done[d]=!!v; W(s); }
function hasPremium(){ const s=S(); return !!s.premium; }
function unlockAt(day, items){
  const s=S(); if(!s.startedAt) return null; let acc=0;
  for(let d=2; d<=day; d++){ const prev=items.find(x=>x.day===d-1); const h=(prev && Number(prev.lockedAfterHours))||12; acc+=h; }
  return s.startedAt + acc*3600*1000;
}
function isUnlockedByTime(day, items){ if(day===1) return true; const t=unlockAt(day,items); return t && Date.now()>=t; }
function timeLeft(ms){ if(ms<=0)return'00:00:00'; const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}`; }

/*** 4) LOAD: GAS → cache → fallback ***/
async function loadItems(){
  try{
    const r=await fetch(API+'?route=content',{cache:'no-store'});
    const tx=await r.text(); const j=JSON.parse(tx);
    if(j.ok && Array.isArray(j.items) && j.items.length){
      const norm=j.items.map(it=>({
        day: Number(it.day)||0,
        title: String(it.title||''),
        body: String(it.body||''),
        lockedAfterHours: Number(it.lockedAfterHours)||12,
        paidTier: String(it.paidTier||'free').toLowerCase()
      })).sort((a,b)=>a.day-b.day);
      localStorage.setItem('mx7_content_cache', JSON.stringify(norm));
      return norm;
    }
    throw new Error('empty');
  }catch(e){
    const cache=localStorage.getItem('mx7_content_cache');
    if(cache){ return JSON.parse(cache); }
    return FALLBACK;
  }
}

/*** 5) SOUND ***/
let ac; function tone(f=660,d=0.09,g=0.04){ try{ ac=ac||new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(), v=ac.createGain(); o.type='sine'; o.frequency.value=f; v.gain.value=g; v.connect(ac.destination); o.connect(v); o.start(); v.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+d); o.stop(ac.currentTime+d);}catch{} }
function clickS(){ tone(660,0.08,0.05) } function unlockS(){ tone(440,0.12,0.06); setTimeout(()=>tone(880,0.12,0.05),90) }

/*** 6) RENDER ***/
function normalizeRange(listRaw){
  const max = Math.max(7, ...listRaw.map(x=>x.day||0));
  const by=new Map(listRaw.map(x=>[Number(x.day)||0,x]));
  const out=[];
  for(let d=0; d<=max; d++){
    if(by.has(d)) out.push(by.get(d));
    else if(d===0) out.push({day:0,title:'Uvod',body:'',lockedAfterHours:0,paidTier:'free'});
    else out.push({day:d,title:`Dan ${d}`,body:'(nema teksta u Sheet-u)',lockedAfterHours:12,paidTier:d<=7?'free':'premium'});
  }
  return out.sort((a,b)=>a.day-b.day);
}
function nextLockedDay(list){
  for(const it of list){ if(it.day>=2 && it.paidTier!=='premium' && !isUnlockedByTime(it.day,list)) return it.day; }
  return null;
}
function canOpen(it, list){
  if(it.day===0 || it.day===1) return true;
  if(it.paidTier==='premium' && !hasPremium()) return false;
  return isUnlockedByTime(it.day, list);
}

function render(listRaw){
  const list=normalizeRange(listRaw);
  const g=$('#grid'); g.innerHTML='';

  // Uvod minimalno
  g.appendChild(tileUvod(list.find(x=>x.day===0)));

  const nextD = nextLockedDay(list); // tajmer samo za prvi zaključani free dan

  list.filter(x=>x.day>=1).forEach(it=>{
    g.appendChild(tileDan(it,list,nextD));
  });
}

function tileUvod(intro){
  const el=document.createElement('div'); el.className='tile';
  el.innerHTML=`
    <div class="tday">Uvod</div>
    <div class="ttitle">${intro.title||''}</div>
    <div style="margin-top:8px"><button class="btn">Otvori</button></div>`;
  el.querySelector('.btn').onclick=()=>{ clickS(); openLesson(0,intro); };
  return el;
}
function tileDan(it, all, nextLocked){
  const d=Number(it.day)||0;
  const open = canOpen(it, all);
  const isPrem = it.paidTier==='premium';
  const el=document.createElement('div'); el.className='tile';
  const badges=[]; badges.push(`<div class="status ${open?'okb':'lockb'}">${open?'OTKLJUČANO':'ZAKLJUČANO'}</div>`); if(isPrem) badges.push(`<div class="status premium">PREMIUM</div>`);
  el.innerHTML=`
    <div style="display:flex;gap:8px;flex-wrap:wrap">${badges.join('')}</div>
    <div class="tday">Dan ${d}</div>
    <div class="ttitle">${it.title||('Dan '+d)}</div>
    <div class="info">
      ${open ? (isDone(d)?'Završeno':'Spremno')
             : (isPrem && !hasPremium() ? 'Premium sadržaj' 
                : (nextLocked===d ? 'Otključava se za <b class="cd"></b>' : 'Zaključano'))}
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" ${open?'':'disabled'}>Otvori</button>
      ${(!open && isPrem && !hasPremium()) ? `<button class="btn gold buy">Otključaj Premium</button>`:''}
    </div>`;
  if(open){
    el.querySelector('.btn').onclick=()=>{ clickS(); openLesson(d,it); };
  }else{
    const cd=el.querySelector('.cd');
    if(cd && nextLocked===d){
      const tick=()=>{ const left=Math.max(0,(unlockAt(d,all)||0)-Date.now()); cd.textContent=timeLeft(left); if(left<=0){ unlockS(); render(all); } };
      tick(); const iv=setInterval(()=>{ if(!document.body.contains(cd)) return clearInterval(iv); tick(); },1000);
    }
    const buy=el.querySelector('.buy');
    if(buy){ buy.onclick=()=>{ clickS(); window.open(PAYMENT_URL,'_blank'); }; }
  }
  return el;
}

/*** 7) MODAL ***/
let currentDay=null;
function openLesson(day, it){
  if(day===1 && !S().startedAt){ ensureStarted(Number(it.lockedAfterHours)||12); setTimeout(()=>render(currentItems),0); }
  currentDay=day;
  document.getElementById('ttl').textContent = day===0 ? 'Uvod' : (it.title||('Dan '+day));
  document.getElementById('body').textContent = it.body||'Nema teksta.';
  document.getElementById('nt').value = localStorage.getItem(LS+'_notes_'+day)||'';
  document.getElementById('done').checked = isDone(day);
  show(true);
}
function show(v){ document.getElementById('ov').style.display=v?'block':'none'; const m=document.getElementById('md'); if(v){ m.classList.add('show'); m.style.display='flex'; }else{ m.classList.remove('show'); setTimeout(()=>m.style.display='none',160);} }
document.getElementById('close').onclick=()=>show(false);
document.getElementById('done').onchange=e=>{ markDone(currentDay,e.target.checked); clickS(); } ;
document.getElementById('nt').oninput=e=>localStorage.setItem(LS+'_notes_'+currentDay,e.target.value||'');

/*** 8) INIT + DIJAGNOSTIKA ***/
function showError(msg){ const b=document.getElementById('err'); b.textContent='Greška: '+msg; b.style.display='block'; }
window.addEventListener('error',e=>{ showError(e.message||'Nepoznata greška'); });

let currentItems=FALLBACK;
(async function(){
  try{
    const items=await loadItems();
    currentItems=items;
    render(items);
  }catch(e){ showError(e.message||String(e)); }
})();
</script>
</body>
</html>
